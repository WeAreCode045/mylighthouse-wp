/**
 * Calendar Modal Class
 * Handles date range picker modal with EasePick
 *
 * @package Mylighthouse_Booker
 */

(function() {
    'use strict';

    class CalendarModal {
        constructor(formElement, options = {}) {
            this.form = formElement;
            this.formId = formElement.id || 'mlb-form-' + Math.random().toString(36).substr(2, 9);
            this.formType = options.formType || 'hotel';
            this.onDateSelect = options.onDateSelect || null;
            
            // Get form data
            this.hotelId = formElement.dataset.hotelId || '';
            this.hotelName = formElement.dataset.hotelName || '';
            this.roomId = formElement.dataset.roomId || '';
            this.roomName = formElement.dataset.roomName || '';
            this.rateId = formElement.dataset.rateId || formElement.dataset.specialId || '';
            
            // Hidden date inputs
            this.checkinInput = formElement.querySelector('.mlb-checkin');
            this.checkoutInput = formElement.querySelector('.mlb-checkout');
            
            this.overlay = null;
            this.picker = null;
            this.isInitialized = false;
        }

        init() {
            if (this.isInitialized) return;
            this.createModalOverlay();
            this.initializePicker();
            this.attachEventListeners();
            this.isInitialized = true;
        }

        createModalOverlay() {
            // Check if overlay already exists
            this.overlay = document.querySelector(`.mlb-calendar-modal-overlay[data-form-id="${this.formId}"]`);
            if (this.overlay) return;

            // Create overlay
            this.overlay = document.createElement('div');
            this.overlay.className = 'mlb-calendar-modal-overlay';
            this.overlay.setAttribute('data-form-id', this.formId);
            
            this.overlay.innerHTML = `
                <div class="mlb-calendar-modal-container
                RangePlugin: {
                    tooltipNumber(num) { 
                        return num - 1; 
                    },
                    locale: {
                        one: 'nacht',
                        other: 'nachten'
                    }
                },
                LockPlugin: {
                    minDate: new Date(),
                    minDays: 1
                },
                setup(picker) {
                    picker.on('select', function(e) {
                        // Auto-submit when both dates are selected
                        if (picker.getStartDate() && picker.getEndDate()) {
                            // Minimal delay for visual feedback
                            setTimeout(function() {
                                if (currentCallback && picker.getStartDate() && picker.getEndDate()) {
                                    // Format dates using native JavaScript to ensure YYYY-MM-DD format
                                    const startDate = new Date(picker.getStartDate());
                                    const endDate = new Date(picker.getEndDate());
                                    
                                    const arrival = startDate.getFullYear() + '-' + 
                                        String(startDate.getMonth() + 1).padStart(2, '0') + '-' + 
                                        String(startDate.getDate()).padStart(2, '0');
                                    
                                    const departure = endDate.getFullYear() + '-' + 
                                        String(endDate.getMonth() + 1).padStart(2, '0') + '-' + 
                                        String(endDate.getDate()).padStart(2, '0');
                                    
                                    const dates = {
                                        arrival: arrival,
                                        departure: departure
                                    };
                                    currentCallback(dates);
                                    close();
                                }
                            }, 200);
                        }
                    });
                }
            });

            wireControls();
            initialized = true;
        } catch (error) {
            console.error('MLB: Error initializing easepick:', error);
        }
    }

    /**
     * Wire up modal controls
     */
    function wireControls() {
        const closeBtn = modal.querySelector('.mlb-modal-close');
        const cancelBtn = modal.querySelector('.mlb-date-cancel');
        const confirmBtn = modal.querySelector('.mlb-date-confirm');
        const overlay = modal.querySelector('.mlb-modal-overlay');

        /**
         * Close modal
         */
        function close() {
            modal.classList.remove('mlb-modal-show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
            
            if (picker) {
                picker.clear();
            }
            currentCallback = null;
            
            const confirmBtn = modal.querySelector('.mlb-date-confirm');
            if (confirmBtn) confirmBtn.disabled = true;
        }

        // Close button
        if (closeBtn) {
            closeBtn.addEventListener('click', close);
        }

        // Cancel button
        if (cancelBtn) {
            cancelBtn.addEventListener('click', close);
        }
        
        // Confirm button
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function() {
                if (!picker || !picker.getStartDate() || !picker.getEndDate()) {
                    return;
                }
                
                const dates = {
                    arrival: picker.getStartDate().format('YYYY-MM-DD'),
                    departure: picker.getEndDate().format('YYYY-MM-DD')
                };

                if (currentCallback) {
                    currentCallback(dates);
                }
                close();
            });
        }

        // Click outside to close
        if (overlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    close();
                }
            });
        }

        // Escape key to close
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.classList.contains('mlb-modal-show')) {
                close();
            }
        });
    }

    /**
     * Open date picker modal
     *
     * @param {Function} callback Callback function to receive selected dates
     */
    function open(callback) {
        if (!initialized) {
            init();
        }

        if (!modal || !picker) {
            console.error('MLB: Date picker not properly initialized');
            return;
        }

        currentCallback = callback;
        
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
            modal.classList.add('mlb-modal-show');
        });
        
        if (picker) {
            picker.show();
        }
        
        const confirmBtn = modal.querySelector('.mlb-date-confirm');
        if (confirmBtn) {
            confirmBtn.disabled = true;
        }
    }

    // Public API
    return {
        open: open
    };
})();

// Initialize on DOM ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        // Initialization will happen on first open()
    });
}
